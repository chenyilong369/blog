# 渲染引擎

**渲染引擎**又名**浏览器内核**，指负责对网页语法解析并渲染成一张可视化页面的解析器。它是浏览器最核心最重要的部位，不同内核对网页语法的解析也有不同，因此同一网页语法在不同内核的浏览器中的渲染效果也可能不同，这就是常说的**浏览器差异性**。

## 渲染过程

要了解浏览器页面的渲染过程，首先得知道`关键渲染路径`。**关键渲染路径**指浏览器从最初接收请求得到HTML、CSS、JS等资源，然后解析、构建、渲染、布局、绘制、合成，到最后呈现在用户眼前界面的整个过程。

在这将页面的渲染过程分为以下几部分。

- **解析文件**
  - 将 html 文件转换为DOM树
  - 将 css 文件转换为CSSOM树
  - 将 DOM 树和 CSSOM 树合并生成渲染树
- **绘制图层**
  - 根据渲染树生成布局渲染树(回流)
  - 根据布局渲染树生成绘制渲染树(重绘)
- **合成图层**：根据绘制渲染树合成图层显示在屏幕上

### 解析文件

HTML 文档描述了一个网页的结构，，浏览器通过 HTML 解析器将 HTML 解析成 DOM 树结构。

构建 DOM 树的过程：读取HTML文档的**字节**，将字节转换成**字符**，依据字符确定**标签**，将标签转换成**节点**，以节点为基准构建**DOM树**。

CSS文档描述一个页面的表现，浏览器通过 CSS 解析器将 CSS 解析成 CSSOM 树结构，与 DOM 树结构比较像。构建过程也与 DOM 树类似。

值得注意的是，在构建DOM树的过程中，当`HTML解析器`遇到`<script>`时会立即阻塞DOM树的构建，将控制权移交给浏览器的`JS引擎`，等到`JS引擎`运行完毕，浏览器才会从中断的地方恢复DOM树的构建。`<script>`的脚本加载完成后，`JS引擎`通过`DOM API`和`CSSOM API`操作DOM树和CSSOM树。为何会产生**渲染阻塞**呢？其根本原因在于：JS操作DOM后，浏览器无法预测未来DOM的具体内容，为了防止无效操作和节省资源，只能阻塞DOM树的构建。

浏览器的`渲染引擎`将DOM树和CSSOM树合并生成渲染树，只渲染需显示的节点及其样式。

<img :src="$withBase('/internetCSS01.png')" alt="internetCSS01"/>

由于上面三棵树的构建无先后条件以及顺序，会形成一边加载，一边解析，一边渲染的工作现象。

## 绘制图层

进入绘制阶段，遍历渲染树，调用渲染器的`paint()`在屏幕上绘制内容。根据渲染树布局计算样式，即每个节点在页面中的布局、尺寸等几何属性。HTML默认是流式布局，CSS和JS会打破这种布局，改变DOM的几何属性和外观属性。在绘制过程中，根据渲染树布局，再根据布局绘制，这就是常听常说的**回流重绘**。

- **回流**：几何属性需改变的渲染
- **重绘**：更改外观属性而不影响几何属性的渲染

在其他文章会重点讲解回流重绘，这里不再详细介绍。

## 合成图层

将回流重绘生成的图层逐张合并并显示在屏幕上。上述几个步骤并不是一次性顺序完成的，若DOM或CSSOM被修改，上述过程会被重复执行。实际上，CSS和JS往往会多次修改DOM或CSSOM，简单来说就是用户的交互操作引发了网页的重渲染。

